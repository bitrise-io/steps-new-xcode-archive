format_version: 11
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  # Shared test configs
  - BITRISE_KEYCHAIN_PATH: $HOME/Library/Keychains/login.keychain
  - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
  - FORCE_TEAM_ID: 72SA8V3WYL
  - IPA_EXPORT_METHOD: development
  - XCODE_OUTPUT_TOOL: xcodebuild
  # Shared test secrets
  - BITRISE_KEYCHAIN_PASSWORD: $BITRISE_KEYCHAIN_PASSWORD
  - BITRISE_CERTIFICATE_URL: $BITRISE_CERTIFICATE_URL
  - BITRISE_CERTIFICATE_PASSPHRASE: $BITRISE_CERTIFICATE_PASSPHRASE
  - BITRISE_PROVISION_URL: $BITRISE_PROVISION_URL
  # Shared test variables
  - ORIG_BITRISE_SOURCE_DIR: $BITRISE_SOURCE_DIR

workflows:
  test_app_clip:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-io/Fruta
    - TEST_APP_BRANCH: xcode-12-gm
    - BITRISE_PROJECT_PATH: Fruta.xcodeproj
    - BITRISE_SCHEME: Fruta iOS
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts

  test_catalyst:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-io/CatalystSample.git
    - TEST_APP_BRANCH: master
    - BITRISE_PROJECT_PATH: Catalyst Sample.xcodeproj
    - BITRISE_SCHEME: Catalyst Sample
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts

  test_cloudkit:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-samples/sample-apps-ios-multi-target.git
    - TEST_APP_BRANCH: cloudkit
    - BITRISE_PROJECT_PATH: code-sign-test.xcodeproj
    - BITRISE_SCHEME: code-sign-test-Prod
    - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: Production
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts

  test_no_app_dsym:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-io/sample-apps-ios-simple-objc.git
    - TEST_APP_BRANCH: with-pods
    - BITRISE_PROJECT_PATH: ios-simple-objc/ios-simple-objc.xcworkspace
    - BITRISE_SCHEME: ios-simple-objc
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts

  test_objc_artifact_name:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-io/sample-apps-ios-simple-objc.git
    - TEST_APP_COMMIT: "65cd120bf4459c2881cfe2b731395b4efc53855d"
    - BITRISE_PROJECT_PATH: ios-simple-objc/ios-simple-objc.xcodeproj
    - BITRISE_SCHEME: ios-simple-objc
    - ARTIFACT_NAME: ios-simple-objc(1234)
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts
    - _check_archive_zip

  test_xcode_8:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-samples/ios-xcode-8.0.git
    - TEST_APP_BRANCH: "swift_version"
    - BITRISE_PROJECT_PATH: ios-xcode-8.0/ios-xcode-8.0.xcodeproj
    - BITRISE_SCHEME: ios-xcode-8.0
    - FORCE_CODE_SIGN_IDENTITY: ""
    - FORCE_TEAM_ID: ""
    - XCODE_OUTPUT_TOOL: xcpretty
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts

  test_multi_target:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-samples/sample-apps-ios-multi-target.git
    - TEST_APP_COMMIT: "ab36ed563bbc3125118e9f27df91474822dc0d46"
    - BITRISE_PROJECT_PATH: code-sign-test.xcodeproj
    - BITRISE_SCHEME: code-sign-test
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts

  test_workspace:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-samples/sample-apps-ios-workspace-swift.git
    - TEST_APP_COMMIT: "1360413258cc7f6a8676c17f060ff39899fc28b1"
    - BITRISE_PROJECT_PATH: sample-apps-ios-workspace-swift.xcworkspace
    - BITRISE_SCHEME: sample-apps-ios-workspace-swift
    - FORCE_PROV_PROFILE_SPECIFIER: "BitriseBot-Wildcard"
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts

  test_tvos:
    envs:
    - TEST_APP_URL: https://github.com/bitrise-samples/sample-apps-tvos-swift.git
    - TEST_APP_BRANCH: "master"
    - BITRISE_PROJECT_PATH: NPO Live.xcworkspace
    - BITRISE_SCHEME: "NPO Live"
    - FORCE_CODE_SIGN_IDENTITY: ""
    - FORCE_TEAM_ID: ""
    - FORCE_PROV_PROFILE_SPECIFIER: ""
    - XCODE_OUTPUT_TOOL: xcpretty
    after_run:
    - _run
    - _check_outputs
    - _check_exported_artifacts

  _run:
    steps:
    - script:
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            rm -rf "$ORIG_BITRISE_SOURCE_DIR/_tmp"
            mkdir -p "$ORIG_BITRISE_SOURCE_DIR/_tmp"
    - git::https://github.com/bitrise-steplib/bitrise-step-simple-git-clone.git@master:
         inputs:
           - repository_url: $TEST_APP_URL
           - branch: $TEST_APP_BRANCH
           - commit: $TEST_APP_COMMIT
           - clone_into_dir: "$ORIG_BITRISE_SOURCE_DIR/_tmp"
    - certificate-and-profile-installer:
        inputs:
        - certificate_url: $BITRISE_CERTIFICATE_URL
        - certificate_passphrase: $BITRISE_CERTIFICATE_PASSPHRASE
        - provisioning_profile_url: $BITRISE_PROVISION_URL
        - install_defaults: "no"
        - keychain_path: $BITRISE_KEYCHAIN_PATH
        - keychain_password: $BITRISE_KEYCHAIN_PASSWORD
    - script:
        run_if: '{{enveq "ARTIFACT_NAME" ""}}'
        inputs:
        - content: envman add --key ARTIFACT_NAME --value $BITRISE_SCHEME
    - path::./:
        inputs:
        - project_path: "$ORIG_BITRISE_SOURCE_DIR/_tmp/$BITRISE_PROJECT_PATH"
        - scheme: $BITRISE_SCHEME
        - artifact_name: $ARTIFACT_NAME
        - force_team_id: $TEAM_ID
        - force_code_sign_identity: $FORCE_CODE_SIGN_IDENTITY
        - force_provisioning_profile_specifier: $FORCE_PROV_PROFILE_SPECIFIER
        - export_method: $IPA_EXPORT_METHOD
        - icloud_container_environment: $ICLOUD_CONTAINER_ENVIRONMENT
        - team_id: $TEAM_ID
        - output_tool: $XCODE_OUTPUT_TOOL
        - verbose_log: "yes"

  _check_outputs:
    steps:
    - script:
        title: Output (generated by the Step) tests
        is_always_run: true
        inputs:
        - content: |-
            echo "-> BITRISE_IPA_PATH:           $BITRISE_IPA_PATH"
            echo "-> BITRISE_DSYM_PATH:          $BITRISE_DSYM_PATH"
            echo "-> BITRISE_XCARCHIVE_ZIP_PATH: $BITRISE_XCARCHIVE_ZIP_PATH"

            echo "-> BITRISE_APP_DIR_PATH:               $BITRISE_APP_DIR_PATH"
            echo "-> BITRISE_DSYM_DIR_PATH:              $BITRISE_DSYM_DIR_PATH"
            echo "-> BITRISE_XCARCHIVE_PATH:             $BITRISE_XCARCHIVE_PATH"
            echo "-> BITRISE_IDEDISTRIBUTION_LOGS_PATH:  $BITRISE_IDEDISTRIBUTION_LOGS_PATH"
            echo "-> BITRISE_XCODE_RAW_RESULT_TEXT_PATH: $BITRISE_XCODE_RAW_RESULT_TEXT_PATH"

  _check_exported_artifacts:
    steps:
    - script:
        title: Validate exported artifacts
        is_always_run: true
        inputs:
        - content: |-            
            #!/usr/bin/env bash

            cd $BITRISE_DSYM_DIR_PATH

            if [ $(ls *.dSYM | wc -l) -eq 0 ]; then
                echo "error, there are no files in the exported dSYM path!"
                exit 1
            fi

            if [ $(ls | wc -l) -gt $(ls *.dSYM | wc -l) ]; then
                echo "error, there are non-dSYM files in the exported dSYM path!"
                exit 1
            fi

  _check_archive_zip:
    steps:
    - script:
        inputs:
        - content: |-
            set -ex

            /usr/bin/unzip $BITRISE_XCARCHIVE_ZIP_PATH -d $ORIG_BITRISE_SOURCE_DIR/_tmp

            archive_path="$ORIG_BITRISE_SOURCE_DIR/_tmp/ios-simple-objc(1234).xcarchive"
            infoplist_path="$archive_path/Info.plist"
            if [[ ! -f "$infoplist_path" ]]; then
              echo "$infoplist_path does not exist."
              exit 1
            fi